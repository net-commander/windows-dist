<!DOCTYPE html>

<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width">
	<title>Documentation Source: manager/DeviceManager_UI.js</title>

	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link type="text/css" rel="stylesheet" href="styles/sunlight.default.css">

	<link type="text/css" rel="stylesheet" href="styles/site.simplex.css">
	<link type="text/css" rel="stylesheet" href="styles/override.css">
	<link type="text/css" rel="stylesheet" href="styles/theme.css">

</head>

<body>

<div class="navbar navbar-default navbar-fixed-top navbar-inverse">
<div class="container">
	<div class="navbar-header">
		<a class="navbar-brand" href="index.html">Documentation</a>
		<button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#topNavigation">
			<span class="icon-bar"></span>
			<span class="icon-bar"></span>
			<span class="icon-bar"></span>
        </button>
	</div>
	<div class="navbar-collapse collapse" id="topNavigation">
		<ul class="nav navbar-nav">
			
			<li class="dropdown">
				<a href="modules.list.html" class="dropdown-toggle" data-toggle="dropdown">Modules<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="module-xcf_driver_DriverBase.html">xcf/driver/DriverBase</a></li><li><a href="module-xcf_manager_BeanManager.html">xcf/manager/BeanManager</a></li><li><a href="module-xcf_manager_DeviceManager.html">xcf/manager/DeviceManager</a></li><li><a href="module-xcf_manager_DeviceManager_DeviceServer.html">xcf/manager/DeviceManager_DeviceServer</a></li><li><a href="module-xide_manager_DeviceManager.html">xide/manager/DeviceManager</a></li>
				</ul>
			</li>
			
			<li class="dropdown">
				<a href="classes.list.html" class="dropdown-toggle" data-toggle="dropdown">Classes<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="module-xcf.driver.DriverBase.html">xcf.driver.DriverBase</a></li><li><a href="module-xcf.manager.DeviceManager_DeviceServer.html">xcf.manager.DeviceManager_DeviceServer</a></li><li><a href="module-xcf_manager_Context.html">xcf/manager/Context</a></li>
				</ul>
			</li>
			
			<li class="dropdown">
				<a href="global.html" class="dropdown-toggle" data-toggle="dropdown">Global<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="global.html#addDeviceInstance">addDeviceInstance</a></li><li><a href="global.html#appScope">appScope</a></li><li><a href="global.html#beanIconClass">beanIconClass</a></li><li><a href="global.html#completeDriver">completeDriver</a></li><li><a href="global.html#createDriverInstance">createDriverInstance</a></li><li><a href="global.html#createLeftView">createLeftView</a></li><li><a href="global.html#createRightView">createRightView</a></li><li><a href="global.html#defaultScope">defaultScope</a></li><li><a href="global.html#driverScopes">driverScopes</a></li><li><a href="global.html#editDriver">editDriver</a></li><li><a href="global.html#groupType">groupType</a></li><li><a href="global.html#insertIfMatch">insertIfMatch</a></li><li><a href="global.html#itemMetaPath">itemMetaPath</a></li><li><a href="global.html#itemMetaStorePath">itemMetaStorePath</a></li><li><a href="global.html#itemMetaTitleField">itemMetaTitleField</a></li><li><a href="global.html#itemType">itemType</a></li><li><a href="global.html#match">match</a></li><li><a href="global.html#newGroup">newGroup</a></li><li><a href="global.html#newItem">newItem</a></li><li><a href="global.html#nodeValuePath">nodeValuePath</a></li><li><a href="global.html#nodeValueTransform">nodeValueTransform</a></li><li><a href="global.html#onCreateVariableCI">onCreateVariableCI</a></li><li><a href="global.html#onDeviceMessage">onDeviceMessage</a></li><li><a href="global.html#onDeviceReady">onDeviceReady</a></li><li><a href="global.html#onMainViewReady">onMainViewReady</a></li><li><a href="global.html#onNewDriverScopeCreated">onNewDriverScopeCreated</a></li><li><a href="global.html#onReloaded">onReloaded</a></li><li><a href="global.html#onStoreReady">onStoreReady</a></li><li><a href="global.html#onWidgetReady">onWidgetReady</a></li><li><a href="global.html#registerEditorExtensions">registerEditorExtensions</a></li><li><a href="global.html#replaceWith">replaceWith</a></li><li><a href="global.html#setScriptFunctions">setScriptFunctions</a></li><li><a href="global.html#start">start</a></li><li><a href="global.html#systemScope">systemScope</a></li><li><a href="global.html#toPreferenceId">toPreferenceId</a></li><li><a href="global.html#updateItemMetaData">updateItemMetaData</a></li><li><a href="global.html#userScope">userScope</a></li><li><a href="global.html#variables">variables</a></li>
				</ul>
			</li>
			
		</ul>
		<div class="col-sm-3 col-md-3">
            <form class="navbar-form" role="search">
                <div class="input-group">
                    <input type="text" class="form-control" placeholder="Search" name="q" id="search-input">
                    <div class="input-group-btn">
                        <button class="btn btn-default" id="search-submit"><i class="glyphicon glyphicon-search"></i></button>
                    </div>
                </div>
            </form>
        </div>
	</div>

</div>
</div>


<div class="container" id="toc-content">
<div class="row">

	
	<div class="col-md-12">
	
		<div id="main">
			

		<h1 class="page-title">Source: manager/DeviceManager_UI.js</h1>
    
<section>
    <article>
        <pre
            class="sunlight-highlight-javascript linenums">/** @module xide/manager/DeviceManager */
define([
    'dcl/dcl',
    "dojo/_base/declare",
    'xide/types',
    'xide/utils',
    'xide/factory',
    'xide/views/ActionDialog',
    'xide/views/CIActionDialog',
    'xide/views/CIGroupedSettingsView',
    'xaction/Action',
    'xide/views/ConsoleView',
    'xide/registry',
    'xlog/views/LogGrid',
    'xide/encoding/MD5',
    'xcf/views/DriverConsole',
    'xide/views/_CIDialog',
    "xide/data/Reference",
    "dojo/Deferred"
], function (dcl,declare, types, utils, factory, ActionDialog, CIActionDialog, CIGroupedSettingsView,
             Action,ConsoleView,registry,LogGrid,MD5,DriverConsole,_CIDialog,Reference,Deferred) {

    var debug = false;
    return dcl(null, {
        declaredClass:"xcf.manager.DeviceManage_UI",
        initUI:function(){

            var thiz = this,
                EVENTS = types.EVENTS;

            this.subscribe(types.EVENTS.ON_APP_READY, function (evt) {
                thiz.onAppReady(evt);
            });

            this.subscribe([
                EVENTS.ON_CI_UPDATE,
                EVENTS.ON_MAIN_VIEW_READY,
                EVENTS.ON_DRIVER_MODIFIED,
                EVENTS.ON_WIDGET_READY]);
            this.subscribe([types.EVENTS.ON_DEVICE_GROUP_SELECTED, types.EVENTS.ON_DEVICE_SELECTED], this.onItemSelected);
        },
        onCIUpdate: function (evt) {

            var ci = evt.ci,
                device = ci ? ci.device : null,
                oldValue = evt.oldValue,
                newValue = evt.newValue,
                state = device ? device.get('state') : -1,
                driverManager = this.ctx.getDriverManager(),
                result = false;

            if(device){

                this.updateCI(evt.ci, evt.newValue, evt.oldValue,device);


                var prop = types.DEVICE_PROPERTY;

                device.refresh();
                device._store.emit('update',{});

                switch (ci.id){

                    case prop.CF_DEVICE_ENABLED:{

                        device.set('enabled',newValue);


                        if(newValue===true){

                            switch (state) {
                                //ignore
                                case types.DEVICE_STATE.READY:
                                case types.DEVICE_STATE.CONNECTED:
                                case types.DEVICE_STATE.CONNECTING:{
                                    break;
                                }
                                case types.DEVICE_STATE.DISCONNECTED:{
                                    result = this.startDevice(device,false);
                                }
                            }
                        }else{

                            switch (state) {
                                case types.DEVICE_STATE.READY:
                                case types.DEVICE_STATE.CONNECTED:
                                case types.DEVICE_STATE.CONNECTING:{
                                    result = this.stopDevice(device);
                                }
                            }
                        }



                        device.set('enabled',newValue);

                        break;
                    }
                    case prop.CF_DEVICE_DRIVER:
                    case prop.CF_DEVICE_HOST:
                    case prop.CF_DEVICE_PROTOCOL:
                    case prop.CF_DEVICE_PORT:{

                    }
                }

                if(ci.id =='Driver'){
                    var driverOld = driverManager.getItemById(oldValue);
                    var driverStore = driverOld._store;
                    if(driverStore) {
                        var driverId = oldValue;
                        var preInstanceId = driverOld.path + '_instances' + '_instance_' + device.path;
                        var preInstanceItem = driverStore.getSync(preInstanceId);
                        if (preInstanceItem) {
                            driverStore.removeSync(preInstanceId);
                            driverOld.refresh();
                        }
                    }


                    driverId = newValue;

                    var driver = driverManager.getItemById(driverId);

                    this.completeDevice(device._store,device,driver,false);
                    var devi = device._store.getSync(device.path);
                    if(!devi){
                        device = device._store.putSync(device);
                        debug &amp;&amp; console.log('- device was removed');
                        device.refresh();
                    }
                    driver.refresh();

                }

            }

            if (evt.owner &amp;&amp; evt.owner.delegate == this) {
                if(evt.didUpdate){
                    return didUpdate;
                }
                evt.didUpdate=true;
                //this.updateCI(evt.ci, evt.newValue, evt.oldValue, evt.storeItem);
            }else{
                //console.log('not my owner');
            }

            return result;
        },
        /**
         * Refresh store from server
         */
        reload: function () {
            var thiz = this;
            this.currentItem = null;
            this.ls('system_devices', function (data) {

                thiz.onStoreReloaded(data);
                if (thiz.treeView) {
                    thiz.treeView.reload(thiz.store);
                }
            });
        },
        /////////////////////////////////////////////////////////////////////////////////////
        //
        //  UX related functions, @TODO : move it to somewhere else
        //
        /////////////////////////////////////////////////////////////////////////////////////
        onItemRemoved: function (item) {
            this.currentItem = null;
            if (item) {
                var view = this.getView(item);
                if (view) {
                    utils.destroyWidget(view);
                }
            }
            this.reload();
        },

        /**
         *
         * @param title
         * @param scope
         * @param parent
         * @returns {*|{name, isDir, parentId, path, beanType, scope}|{name: *, isDir: *, parentId: *, path: *, beanType: *, scope: *}}
         */
        createNewGroupItem:function(title,scope,parent){
            return this.createItemStruct(title,scope,parent,title,true,types.ITEM_TYPE.DEVICE_GROUP);
        },
        /**
         *
         * @param title
         * @param scope
         * @param parent
         * @returns {*|{name, isDir, parentId, path, beanType, scope}|{name: *, isDir: *, parentId: *, path: *, beanType: *, scope: *}}
         */
        createNewItem: function (title, scope, parent) {
            return this.createItemStruct(title, scope, parent, parent + "/" + title, false, types.ITEM_TYPE.DEVICE);
        },
        //bean manager override
        onItemSelected: function (item) {
            this.currentItem = item;
        },
        onReloaded: function () {
            this.checkDeviceServerConnection();
        },
        openLog:function(item){


            // default grid args
            var thiz = this,
                ctx = thiz.ctx,
                logManager = ctx.getLogManager(),
                store = logManager.store,
                info = item.info || this.toDeviceControlInfo(item),
                docker = ctx.mainView.getDocker(),
                host= utils.replaceAll('/','_',info.host),
                storeId = host + '_' + info.port + '_' + info.protocol;


            console.log('open log '+storeId);;
            logManager.getStore(storeId).then(function(_store){
                var logGridArgs = {
                    ctx: ctx,
                    attachDirect: true,
                    storeId:storeId,
                    delegate:logManager,
                    getRootFilter:function(){
                        return {
                            show:true,
                            host:info.host + ':' + info.port
                        }
                    },
                    collection: _store.filter({
                        show:true,
                        host:info.host + ':' + info.port
                    }).sort([{property: 'time', descending: true}])
                };
                var tab = docker.addTab(null,{
                    title: info.host,
                    icon:'fa-calendar'
                });

                var grid = utils.addWidget(LogGrid,logGridArgs,null,tab,true,'logGridView');
            });
        },
        /**
         * Open a device console, it used the current selected device item from the tree
         * widget
         * @returns {widgetProto}
         */
        openConsole:function(device,where,mixin){

            var enabled = this.getMetaValue(device, types.DEVICE_PROPERTY.CF_DEVICE_ENABLED);
            if(!enabled){
                return null;
            }

            this.startDevice(device);

            var cInfo = this.toDeviceControlInfo(device);

            cInfo['clientSide'] = true;


            var hash = MD5(JSON.stringify(cInfo), 1),
                viewId = hash + '-Console',
                thiz = this,
                deviceInstance = this.deviceInstances[hash],
                driver = deviceInstance.driver,
                docker = this.ctx.mainView.getDocker(),
                self = this;

            debug &amp;&amp; console.log('open console ' + hash,cInfo);

            var scope = driver.blockScope,
                instance = scope.instance,
                originalScope = instance ? instance.blockScope : null,
                blockScope = originalScope || scope,
                driverInstance = this.getDriverInstance(cInfo, true),
                startup = where == null;


            where = where || docker.addTab(null,{
                title: cInfo.host,
                icon: 'fa-terminal'
            });



            var ConsoleViewClass = dcl(DriverConsole,{
                destroy:function(){
                    self.consoles[viewId].remove(this);
                }
            });


            var args =  utils.mixin({
                driver:driver,
                device:device,
                deviceInstance:deviceInstance,
                driverInstance:driverInstance,
                blockScope:blockScope,
                value:mixin ? mixin.value : ''
            },mixin);


            var view = utils.addWidget(ConsoleViewClass,utils.mixin({
                ctx:this.ctx,
                type:'javascript',
                value:'return this.getVariable(\'Volume\');',
                editorArgs:args,
                owner:this,
                log: function (msg) {

                    var printTemplate = '&lt;pre style="font-size:100%;padding: 0px;" class="">    ${time} - ${result}&lt;/pre>';
                    var out = '';
                    if (_.isString(msg)) {
                        out += msg.replace(/\n/g, '&lt;br/>');
                    } else if (_.isObject(msg) || _.isArray(msg)) {
                        out += JSON.stringify(msg, null, true);
                    }
                    var items = out.split('&lt;br/>');

                    for (var i = 0; i &lt; items.length; i++) {
                        this.printCommand('',items[i],this.logTemplate,true);
                    }
                },
                onConsoleEnter: function(command){

                    var consoleWidget = this.getConsole();

                    var thiz = this,
                        failed = false;

                    function expressionError(message,error){
                        //console.error('expression error ' + error.message);
                        _resolved = '&lt;span class="text-primary">&lt;b>' + command + '&lt;/span>&lt;/b>&lt;span class="text-info">'  +  '  failed: &lt;span class="text-danger">' + error.message +  '&lt;/span>';
                        thiz.printCommand(_resolved,'');
                        failed = true;
                        //return command;
                        return null;
                    }




                    var _resolved = this.parse(command,expressionError);

                    if(failed){
                        return null;
                    }

                    this.owner.sendDeviceCommand(this.deviceInstance, _resolved);

                    if (_resolved == command) {
                        _resolved == '';
                    } else {
                        _resolved = '&lt;span class="text-info">&lt;b>' + command + '&lt;/span>&lt;/b>&lt;span>'  +  '  evaluates to &lt;span class="text-success">' + _resolved +  '&lt;/span>';
                    }
                    this.printCommand(_resolved,'');
                    return _resolved;
                }

            },args),null,where,startup);


            where.add(view,null,false);

            view.consoleId = viewId;

            if(!this.consoles){
                this.consoles = [];
            }

            if(!this.consoles[viewId]){
                this.consoles[viewId] = [];
            }
            this.consoles[viewId].push(view);
            view._on('destroy',function(e){
                thiz.consoles[viewId].remove(view);
            });
            return view;

        },
        completeDevice: function (store, device,driver,subscribe) {


            if (!driver.id) {
                console.error('have no id!');
            }

            var parentId = device.path,
                ctx = this.ctx;

            device.directory=true;
            device.isDevice=true;

            var meta = device['user'];

            var protocolCI = utils.getCIByChainAndName(meta, 0, types.DEVICE_PROPERTY.CF_DEVICE_PROTOCOL);
            if(protocolCI){
                protocolCI.type = 3;
                protocolCI.options = [
                    {
                        label:"TCP",
                        value:"tcp"
                    },
                    {
                        label:"UDP",
                        value:"tcp"
                    },
                    {
                        label:"Driver",
                        value:"driver"
                    },
                    {
                        label:"SSH",
                        value:"ssh"
                    },
                    {
                        label:"Serial",
                        value:"serial"
                    },
                    {
                        label:"MQTT",
                        value:"mqtt"
                    }
                ]

            }

            var optionsCI = utils.getCIByChainAndName(meta, 0, types.DEVICE_PROPERTY.CF_DEVICE_OPTIONS);
            if(!optionsCI){

                meta.inputs.push({
                    "chainType": 0,
                    "class": "cmx.types.ConfigurableInformation",
                    "dataRef": "",
                    "dataSource": "",
                    "description": null,
                    "enabled": true,
                    "enumType": "-1",
                    "flags": -1,
                    "group": 'Network',
                    "id": "options",
                    "name": "options",
                    "order": 1,
                    "params": null,
                    "platform": null,
                    "title": "Options",
                    "type": 28,
                    "uid": "-1",
                    "value": {
                    },
                    "visible": true,
                    "device":device

                });
            }else{

                optionsCI.device = device;
            }


            this.fixDeviceCI(device);


            var driverScope = driver.blockScope || this.ctx.getBlockManager().getScope(driver.id),
                commands = {
                    path: parentId + '_commands',
                    name: 'Commands',
                    isDir: true,
                    type: 'leaf',
                    parentId: parentId,
                    virtual: true
                },
                blockStore = driverScope.blockStore;

            if(store.getSync(parentId + '_commands')){

                store.removeSync(parentId + '_commands');
                var subs = store.query({
                    parentId:parentId + '_commands'
                });
                if(subs){
                    _.each(subs,function(sub){
                        store.removeSync(sub.path);
                    })
                }
            }

            //complete commands
            store.putSync(commands);

            device.commandsItem=commands;


            var variables = {
                path: parentId + '_variables',
                name: 'Variables',
                isDir: true,
                type: 'leaf',
                parentId: parentId,
                virtual: true
            };

            device.variablesItem=variables;

            if(store.getSync(parentId + '_variables')){

                store.removeSync(parentId + '_variables');
                var subs = store.query({
                    parentId:parentId + '_variables'
                });
                if(subs){
                    _.each(subs,function(sub){
                        store.removeSync(sub.path);
                    })
                }
            }
            store.putSync(variables);


            var commandBlocks = driverScope.getBlocks({
                group: types.COMMAND_TYPES.BASIC_COMMAND
            });
            commandBlocks = commandBlocks.concat(driverScope.getBlocks({
                group: types.COMMAND_TYPES.CONDITIONAL_COMMAND
            }));

            function createReference(block,driver,title,icon){

                var _isVariable = block.declaredClass.indexOf('model.Variable') !==-1 &amp;&amp; block.declaredClass.indexOf('VariableSwitch') ==-1;
                var _parent = _isVariable  ? variables.path : commands.path;
                /*
                if(block.parentId!==null){
                    return;
                }
                */
                if(block.isCommand!==true &amp;&amp; (block.declaredClass.indexOf( _isVariable? 'Variable' : 'Command')==-1)){
                    //console.log('--- not a '+ title,block);
                    return;
                }
                //console.log('--- not a '+ title,block);

                var reference  = new Reference({
                    enabled:true,
                    path: utils.createUUID(),
                    name: title,
                    id: block.id,
                    parentId: _parent,
                    _mayHaveChildren: false,
                    virtual: true,
                    tooltip: true,
                    icon:icon,
                    command:!_isVariable,
                    ref: {
                        driver: driver,
                        item: block,
                        device:device
                    },
                    type: types.ITEM_TYPE.BLOCK
                });

                reference = store.putSync(reference);

                block.addReference(reference,{
                    properties: {
                        "name":true,
                        "enabled":true,
                        "value":true
                    },
                    onDelete:true
                },true);

                reference.refresh();
            }

            _.each(commandBlocks,function(block){
                createReference(block,driver,block.name,block.icon || 'fa-exclamation');
            });


            subscribe !==false &amp;&amp; blockStore.on('added',function(block){
                createReference(block,driver,block.name,block.icon || 'fa-exclamation');
            });

            subscribe !==false &amp;&amp; blockStore.on('delete',function(evt){
                store.removeSync(evt.id);
                evt.target.refresh();
            });




            var basicVariables = driverScope.getVariables({
                group: types.BLOCK_GROUPS.CF_DRIVER_BASIC_VARIABLES
            });

            var i = _.find(basicVariables,{
                id:'3403a69e-252a-30dc-b130-40a028d1cde4'
            });

            basicVariables = basicVariables.concat(driverScope.getVariables({
                group: types.BLOCK_GROUPS.CF_DRIVER_RESPONSE_VARIABLES
            }));

            _.each(basicVariables,function(variable){
                createReference(variable,driver,variable.name,variable.icon || 'fa-code');
            });

/*
            for (var i = 0; i &lt; basicVariables.length; i++) {
                var variable = basicVariables[i];
                store.putSync({
                    path: utils.createUUID(),
                    name: variable.title,
                    id: variable.id,
                    parentId: variables.path,
                    _mayHaveChildren: false,
                    virtual: true,
                    ref: {
                        driver: driver,
                        item: variable,
                        device:device
                    },
                    type: types.ITEM_TYPE.BLOCK
                });
            }
*/

            ctx.getDriverManager().addDeviceInstance(device,driver);
        },
        _getDevices:function(){

            var store = this.getStore();
            var items = utils.queryStore(store, {
                isDir: false
            });

            if (items._S) {
                items = [items];
            }
            return items;
        },
        /***
         * Add driver related items to each device store item.
         */
        completeDeviceStore: function () {


            var driverMgr = this.ctx.getDriverManager();

            var store = this.getStore();

            var items = utils.queryStore(store, {
                isDir: false
            });

            if (items._S) {
                items = [items];
            }
            store.on('delete',function(item){
                debugger;
            });
            try {

                for (var i = 0; i &lt; items.length; i++) {

                    var device = items[i];

                    var enabled = this.getMetaValue(device, types.DEVICE_PROPERTY.CF_DEVICE_ENABLED);
                    if (device['_completed'] != null) {
                        continue;
                    }
                    device['_completed'] = [true];
                    var driverId = this.getMetaValue(device, types.DEVICE_PROPERTY.CF_DEVICE_DRIVER);
                    if (!driverId) {
                        console.error('device has no driver id!');
                        continue;
                    }
                    var driver = this.ctx.getDriverManager().getItemById(driverId);
                    if (driver) {
                        this.completeDevice(device, driver);
                    } else {
                        console.error('device has no driver!');
                    }

                }
            } catch (e) {
                debugger;
            }



        },
        onDeviceTreeViewCreated: function (view) {
            debug &amp;&amp; console.log('device tree view created');
        },
        /***
         * Callback when a file widget has been created. We extend this widget for one more buttons:
         *
         * @param widget
         * @param ci
         * @param storeItem
         */
        onDriverClassFileWidgetCreated: function (widget, ci, storeItem) {

            var thiz = this;

            widget.debugButton = factory.createButton(
                widget.getFreeExtensionSlot(),//the widget knows where to add new items
                "el-icon-puzzle",             //eluisve icon class
                "elusiveButton",              //elusive button class adjustments
                "",                           //no label
                "",                           //no extra dom style markup
                function () {                   //button click callback
                    thiz.debugDriver(ci, storeItem);
                },
                this);

            widget.editButton = factory.createButton(
                widget.getFreeExtensionSlot(),//the widget knows where to add new items
                "el-icon-file-edit",             //eluisve icon class
                "elusiveButton",              //elusive button class adjustments
                "",                           //no label
                "",                           //no extra dom style markup
                function () {                   //button click callback
                    thiz.editDriver(ci, storeItem);
                },
                this);


        },
        /**
         * Somebody opened a widget
         * @param evt
         */
        onWidgetReady: function (evt) {
            if (evt['owner'] == this                   // must come from us
                &amp;&amp; evt['ci'] != null                   // we need an CI
                &amp;&amp; utils.toString(evt['ci'].name) === types.DRIVER_PROPERTY.CF_DRIVER_CLASS    // we need an CI
                &amp;&amp; evt['widget'] != null               // we need a valid widget
                &amp;&amp; evt['storeItem'] != null            // we need a store reference
                &amp;&amp; utils.toInt(evt['ci'].type) === types.ECIType.FILE) //must be a file widget
            {
                this.onDriverClassFileWidgetCreated(evt.widget, evt.ci, evt.storeItem);
            }
        },
        /**
         * Bean UX function to create a new item by opening a dialog, followed by a server call
         */
        newItem: function (currentItem) {

            var thiz = this;

            if (!currentItem) {
                currentItem = {
                    path: ""
                }
            }

            var drivers = this.ctx.getDriverManager().getDriversAsEnumeration();
            var parent = currentItem ? currentItem.isDir === true ? currentItem.path : '' : '';

            var dfd = new Deferred();

            var cis = [

                utils.createCI('In Group', 13,parent, {
                    widget: {
                        disabled: true
                    },
                    group: 'Common',
                    visiable:false
                }),
                utils.createCI('Title', 13, 'MyNewDevice', {
                    group: 'Common'
                }),
                utils.createCI('Enabled', 0, '', {
                    group: 'Common',
                    value: false
                }),
                utils.createCI('Scope', 3, 'system_devices', {
                    group: 'Common',
                    options: [
                        {
                            label: 'System',
                            value: 'system_devices'
                        },
                        {
                            label: 'User',
                            value: 'user_devices'
                        },
                        {
                            label: 'App',
                            value: 'app_devices'
                        }
                    ]
                }),
                utils.createCI('Driver', 3, drivers.length > 0 ? drivers[0].value : '', {
                    group: 'Common',
                    options: drivers,
                    name: types.DEVICE_PROPERTY.CF_DEVICE_DRIVER,
                    enumType: 'Driver'
                }),
                utils.createCI('Network-Settings', types.ECIType.DEVICE_NETWORK_SETTINGS, 'no value')
            ];




            var actionDialog = new _CIDialog({
                title: 'New Device',
                resizable: true,
                onOk: function (data) {

                    var idCi = utils.createCI('Id', 13, utils.createUUID(), {
                        visible: false,
                        group:"Common"
                    });

                    data.push(idCi);

                    var options = utils.toOptions(data);
                    var nameCi = utils.getInputCIByName(cis, "Title");
                    var scopeCi = utils.getInputCIByName(cis, "Scope");

                    thiz.createItem(options, function (newItemData) {

                        var newItem = thiz.createNewItem(nameCi.value, scopeCi.value, parent);

                        newItem.path += '.meta.json';
                        newItem.user = {
                            inputs:newItemData
                        };
                        newItem.id = idCi.value;

                        var device = thiz.store.putSync(newItem);

                        _.each(device.user.inputs,function(ci){
                            ci.device = device;
                        });


                        thiz.publish(types.EVENTS.ON_STORE_CHANGED, {
                            owner: thiz,
                            store: thiz.store,
                            action: types.NEW_FILE,
                            item: device
                        });

                        device.refresh();

                        dfd.resolve(device);

                    });
                },
                delegate: {

                },
                cis: cis
            });

            actionDialog.show();

            return dfd;
        },
        newGroup: function (item,scope) {
            var thiz = this;
            var currentItem = this.getItem();
            var parent = currentItem ? utils.toBoolean(currentItem.isDir) === true ? utils.toString(currentItem.path) : '' : '';
            var store = this.getStore(scope);
            var dfd = new Deferred();
            var actionDialog = new _CIDialog({
                title: 'New Device Group',
                onOk: function (dlg, data) {

                    var title = this.getField('Title');
                    var scope = this.getField('Scope');

                    var _final = parent + '/' + title;

                    thiz.createGroup(scope, _final, function () {

                        var newItem = thiz.createNewGroupItem(title, scope, parent);
                        store.putSync(newItem);
                        thiz.publish(types.EVENTS.ON_STORE_CHANGED, {
                            owner: thiz,
                            store: thiz.store,
                            action: types.NEW_DIRECTORY,
                            item: newItem
                        });
                        store.refreshItem(newItem);
                        dfd.resolve(newItem);
                    });
                },
                delegate: {

                },
                cis: [
                    utils.createCI('Title', 13, ''),
                    utils.createCI('Scope', 3, 'system_devices', {
                        "options": [
                            {
                                label: 'System',
                                value: 'system_devices'
                            },
                            {
                                label: 'User',
                                value: 'user'
                            },
                            {
                                label: 'App',
                                value: 'app'
                            }
                        ]
                    })
                ]
            });
            actionDialog.show();
            return dfd;
        },
        onDriverModified:function(evt){

            debug &amp;&amp; console.log('on driver modified',this.getStore());

            var store = this.getStore(),
                items = store ? utils.queryStore(store, {
                    isDir: false
                }) : [];


            var driverManager = this.ctx.getDriverManager();

            for (var i = 0; i &lt; items.length; i++) {

                var item = items[i];
                var driverId = this.getMetaValue(item, types.DEVICE_PROPERTY.CF_DEVICE_DRIVER);
                if (!driverId) {
                    console.error('device has no driver id!');
                    continue;
                }

                var driver = driverManager.getItemById(driverId);

                if(item.commandsItem) {
                    utils.removeFromStore(store, item.commandsItem, true, 'path', 'parentId');
                }

                if(item.variablesItem) {
                    utils.removeFromStore(store, item.variablesItem, true, 'path', 'parentId');
                }

                this.completeDevice(store, item, driver);
            }

            /*
            var store = this.getStore();
            var item = evt.driver;

            if(item.commandsItem) {
                utils.removeFromStore(store, item.commandsItem, true, 'path', 'parentId');
            }

            if(item.variablesItem) {
                utils.removeFromStore(store, item.variablesItem, true, 'path', 'parentId');
            }

            item._completed=false;

            this.completeDevice(store,item,item);*/


        },
        onDeleteItem: function (item) {

            var isDir = utils.toBoolean(item.isDir) === true;
            var name = utils.toString(item['name']);
            //pick the right service function

            var removeFn = isDir ? 'removeGroup' : 'removeItem';
            var thiz = this;
            var actionDialog = new _CIDialog({
                title: 'Remove Device' + (isDir ? ' Group' : '') + ' ' + '\"' + name + '\"',
                style: 'max-width:400px',
                titleBarClass: 'text-danger',
                onOk: function (dlg) {

                    var store = thiz.getStore(item.scope);

                    thiz[removeFn](
                        utils.toString(item.scope),
                        utils.toString(item.path),
                        utils.toString(item.name),
                        function () {

                            store.removeSync(item.path);

                            thiz.publish(types.EVENTS.ON_STORE_CHANGED, {
                                owner: thiz,
                                store: store,
                                action: types.DELETE,
                                item: item
                            });
                        });
                },
                delegate: {
                    isRemoving: false

                },
                inserts: [{
                    query: '.dijitDialogPaneContent',
                    insert: '&lt;div>&lt;span class="fileManagerDialogText">Do you really want to remove  this item' + '?&lt;/span>&lt;/div>',
                    place: 'first'
                }]
            });
            actionDialog.show();
        },
        /***
         * openItemSettings creates a new settings view for a driver
         * @param item
         * @returns {xide.views.CIGroupedSettingsView}
         */
        openItemSettings: function (item) {


            //1. sanity check
            var userData = item.user;
            if (!userData || !userData.inputs) {
                return null;
            }

            //2. check its not open already
            var viewId = this.getViewId(item);
            var view = registry.byId(viewId);
            try {
                if (view) {
                    if (view._parent) {
                        view._parent.select(view);
                    }
                    return view;
                }
            } catch (e) {
                utils.destroyWidget(view);
            }

            var docker = this.ctx.mainView.getDocker();
            var parent = docker.addTab(null, {
                title: title || utils.toString(item.name),
                icon: this.beanIconClass
            });


            var title = this.getMetaValue(item, types.DEVICE_PROPERTY.CF_DEVICE_TITLE);
            //var title = this.getMetaValue(item, types.DEVICE_PROPERTY.CF_DEVICE_TITLE);

            var meta = item['user'];

            this.fixDeviceCI(item);


            var driverOptions= utils.getCIByChainAndName(meta, 0, types.DEVICE_PROPERTY.CF_DEVICE_OPTIONS);


            view = utils.addWidget(CIGroupedSettingsView, {
                title: title || utils.toString(item.name),
                cis: userData.inputs,
                storeItem: item,
                id: this.getViewId(item),
                iconClass: "fa-sliders " + this.getDeviceStatusIcon(item),
                delegate: this,
                storeDelegate: this,
                closable: true,
                owner:this
            }, this, parent, true, 'deviceView');


            this.publish(types.EVENTS.RESIZE);

            //this.ctx.getWindowManager().registerView(view,true);

            return view;
        },
        /////////////////////////////////////////////////////////////////////////////////////
        //
        //  Bean protocol impl.
        //
        /////////////////////////////////////////////////////////////////////////////////////
        _getIcon: function (item) {

            var state = item.state;
            switch (state) {
                case types.DEVICE_STATE.CONNECTING:
                    return 'iconStatusBusy';
                case types.DEVICE_STATE.CONNECTED:
                    return 'fa-signal';
                case types.DEVICE_STATE.DISABLED:
                case types.DEVICE_STATE.DISCONNECTED:
                    return 'fa-dot-circle-o';
            }
            return 'fa-dot-circle-o';
        },
        getItemActions: function () {
            try {
                var actions = [];
                var thiz = this;

                var selectedItem = this.getItem();

                var isGroup = selectedItem ? selectedItem.isDir === true : false;

                if (selectedItem &amp;&amp; !selectedItem.ref &amp;&amp; ( selectedItem.name == 'Commands' || selectedItem.name == 'Variables')) {
                    return actions;
                }
                if (!selectedItem || selectedItem['ref'] == null /*&amp;&amp; utils.toString(selectedItem.name)!=='Commands' &amp;&amp; utils.toString(selectedItem.name)!=='Variables'*/) {
                }

                //item actions
                if (selectedItem) {

                    if (!selectedItem.ref) {

                    }

                    //new item
                    if (isGroup) {

                    } else {

                        /**
                         * Command or Variable selected
                         */
                        if (selectedItem.ref) {

                            return [];
                        }


                        var state = selectedItem.state || types.DEVICE_STATE.DISCONNECTED;
                        var connectAction = null;

                        if (state == types.DEVICE_STATE.DISCONNECTED ||
                            state == types.DEVICE_STATE.DISABLED) {

                            //Connect
                            connectAction = Action.create('Connect', 'fa-link', 'Edit/Connect', false, null, 'Device', 'deviceAction', null, true, function () {
                                thiz.startDevice(selectedItem)
                            }, {object: selectedItem}).setVisibility(types.ACTION_VISIBILITY.ACTION_TOOLBAR, {label: ''});

                        } else if (state == types.DEVICE_STATE.CONNECTED) {

                            connectAction = Action.create('Stop', 'fa-unlink', 'Edit/Stop', false, null, 'Device', 'deviceAction', null, true, function () {
                                thiz.stopDevice(selectedItem);
                            }, {object: selectedItem}).setVisibility(types.ACTION_VISIBILITY.ACTION_TOOLBAR, {
                                label: '',
                                style: 'color:red'
                            });

                        } else if (state == types.DEVICE_STATE.CONNECTING) {

                            connectAction = Action.create('Stop', 'fa-unlink', 'Edit/Stop', false, null, 'Device', 'deviceAction', null, true, function () {
                                thiz.stopDevice(selectedItem);
                            }, {object: selectedItem}).setVisibility(types.ACTION_VISIBILITY.ACTION_TOOLBAR, {
                                label: '',
                                style: 'color:red'
                            });
                        }

                        connectAction.subscribe(types.EVENTS.ON_DEVICE_STATE_CHANGED, function (evt) {
                            if (!evt.item || !evt.item.state) {
                                return;
                            }
                            var icon,
                                handler;

                            switch (evt.item.state) {
                                case types.DEVICE_STATE.DISCONNECTED:
                                case types.DEVICE_STATE.DISABLED:
                                {
                                    icon = "fa-link";
                                    handler = function () {
                                        thiz.startDevice(selectedItem)
                                    };
                                    break;
                                }
                                case types.DEVICE_STATE.CONNECTING:
                                {
                                    icon = "fa-spinner fa-spin";
                                    handler = function () {
                                        thiz.stopDevice(selectedItem)
                                    };
                                    break;
                                }
                                case types.DEVICE_STATE.CONNECTED:
                                {
                                    icon = "fa-unlink";
                                    handler = function () {
                                        thiz.stopDevice(selectedItem)
                                    };
                                }

                            }
                            var visibility = this.getVisibility(types.ACTION_VISIBILITY.ACTION_TOOLBAR);
                            if (visibility.widget) {
                                visibility.widget.set('iconClass', icon);

                            }
                            this.handler = handler;

                        });

                        actions.push(connectAction);

                        var _consoleAction = Action.create('Console', 'el-icon-indent-left', 'View/Console', false, null, 'Device', 'deviceAction', null, true, function () {
                            thiz.openConsole(selectedItem);
                        }).setVisibility(types.ACTION_VISIBILITY.ACTION_TOOLBAR, {label: ''});
                        actions.push(_consoleAction);
                        this._lastActions = actions;

                    }
                }
            } catch (e) {
                debugger;
            }
            return actions;
        },
        hasItemActions: function () {
            return true;
        },
        onMainViewReady: function () {

            var thiz = this;

            /**
             * Register permanent actions
             */
            var newDevice = Action.createDefault('New Device', 'el-icon-file-new', 'File/New/Device', '__anewAction', null, {
                permanent: true,
                handler: function () {
                    thiz.newItem();
                }

            }).setVisibility(types.ACTION_VISIBILITY.ACTION_TOOLBAR, null).
                setVisibility(types.ACTION_VISIBILITY.MAIN_MENU, {}).
                setVisibility(types.ACTION_VISIBILITY.CONTEXT_MENU, null);

            thiz.publish(types.EVENTS.REGISTER_ACTION, {
                owner: thiz,
                action: newDevice
            });

        }
    });
});
</pre>
    </article>
</section>





		</div>
	</div>

	<div class="clearfix"></div>

	

</div>
</div>

<div class="modal fade" id="searchResults">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title">Search results</h4>
      </div>
      <div class="modal-body"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div>

<footer>


<span class="jsdoc-message">
	Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a>
	
		on 2016-06-02T17:42:36+02:00
	
	using the <a href="https://github.com/docstrap/docstrap">DocStrap template</a>.
</span>
</footer>

<script src="scripts/docstrap.lib.js"></script>
<script src="scripts/toc.js"></script>
<script type="text/javascript" src="scripts/fulltext-search-ui.js"></script>

<script>
$( function () {
	$( "[id*='$']" ).each( function () {
		var $this = $( this );

		$this.attr( "id", $this.attr( "id" ).replace( "$", "__" ) );
	} );

	$( ".tutorial-section pre, .readme-section pre" ).each( function () {
		var $this = $( this );

		var example = $this.find( "code" );
		exampleText = example.html();
		var lang = /{@lang (.*?)}/.exec( exampleText );
		if ( lang && lang[1] ) {
			exampleText = exampleText.replace( lang[0], "" );
			example.html( exampleText );
			lang = lang[1];
		} else {
			var langClassMatch = example.parent()[0].className.match(/lang\-(\S+)/);
			lang = langClassMatch ? langClassMatch[1] : "javascript";
		}

		if ( lang ) {

			$this
			.addClass( "sunlight-highlight-" + lang )
			.addClass( "linenums" )
			.html( example.html() );

		}
	} );

	Sunlight.highlightAll( {
		lineNumbers : true,
		showMenu : true,
		enableDoclinks : true
	} );

	$.catchAnchorLinks( {
        navbarOffset: 10
	} );
	$( "#toc" ).toc( {
		anchorName  : function ( i, heading, prefix ) {
			var id = $( heading ).attr( "id" );
			return id && id.replace(/\~/g, '-inner-').replace(/\./g, '-static-') || ( prefix + i );
		},
		selectors   : "#toc-content h1,#toc-content h2,#toc-content h3,#toc-content h4",
		showAndHide : false,
		smoothScrolling: true
	} );

	$( "#main span[id^='toc']" ).addClass( "toc-shim" );
	$( '.dropdown-toggle' ).dropdown();

    $( "table" ).each( function () {
      var $this = $( this );
      $this.addClass('table');
    } );

} );
</script>



<!--Navigation and Symbol Display-->


<!--Google Analytics-->


<script type="text/javascript">
	$(document).ready(function() {
		SearcherDisplay.init();
	});
</script>

</body>
</html>
