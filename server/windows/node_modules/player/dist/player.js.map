{"version":3,"sources":["../libs/player.js"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;kBAQe,IAAI;;;;oBACF,MAAM;;;;oBACN,MAAM;;;;+BACK,kBAAkB;;oBAC7B,MAAM;;;;oBACN,MAAM;;;;0BACT,YAAY;;;;uBACN,SAAS;;;;2BACN,aAAa;;;;yBACjB,YAAY;;;;sBACF,QAAQ;;qBACmC,SAAS;;AAEjF,IAAM,QAAQ,GAAG;AACf,OAAK,EAAE,KAAK;AACZ,SAAO,EAAE,KAAK;AACd,UAAQ,EAAE,KAAK;AACf,WAAS,EAAE,KAAK;AAChB,aAAW,EAAE,mBAAM;AACnB,cAAY,EAAE,OAAO,CAAC,GAAG,CAAC,UAAU,IAAI,OAAO,CAAC,GAAG,CAAC,UAAU,IAAI,IAAI,EACvE,CAAA;;;;;;;;IAOoB,MAAM;AACd,WADQ,MAAM,CACb,KAAK,EAAE,MAAM,EAAE;0BADR,MAAM;;;;;;AAMvB,+BANiB,MAAM,6CAMhB;;AAEP,QAAI,CAAC,OAAO,GAAG,EAAE,CAAA;AACjB,QAAI,CAAC,MAAM,GAAG,KAAK,CAAA;AACnB,QAAI,CAAC,OAAO,GAAG,wBAAE,MAAM,CAAC,QAAQ,EAAE,MAAM,CAAC,CAAA;AACzC,QAAI,CAAC,KAAK,GAAG,OA3Bc,MAAM,CA2Bb,KAAK,IAAI,EAAE,EAAE,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,CAAA;AAClD,QAAI,CAAC,IAAI,CAAC,KAAK,IAAI,CAAC,IAAI,CAAC,KAAK,CAAC,MAAM,EAAE,IAAI,CAAC,KAAK,GAAG,EAAE,CAAA;GACvD;;YAbkB,MAAM;;eAAN,MAAM;;;;WAgBnB,gBAAC,CAAC,EAAE;AACR,UAAI,CAAC,OAAO,CAAC,CAAC,CAAC,GAAG,IAAI,CAAA;AACtB,aAAO,IAAI,CAAA;KACZ;;;WAEM,iBAAC,CAAC,EAAE;AACT,UAAI,CAAC,OAAO,CAAC,CAAC,CAAC,GAAG,KAAK,CAAA;AACvB,aAAO,IAAI,CAAA;KACZ;;;;;;;;;SAOO,YAAG;;;AACT,UAAI,CAAC,IAAI,CAAC,KAAK,EACb,OAAM;;AAER,aAAO,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,UAAA,EAAE;eAAI,EAAE,CAAC,OAAK,OAAO,CAAC,GAAG,CAAC;OAAA,CAAC,CAAA;KAClD;;;;;SAGU,YAAG;AACZ,UAAI,CAAC,IAAI,CAAC,OAAO,CAAC,MAAM,EACtB,OAAO,IAAI,CAAA;;AAEb,aAAO,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,OAAO,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC,CAAA;KACzD;;;;;;;;WAMG,gBAAY;;;UAAX,KAAK,gCAAG,CAAC;;AACZ,UAAI,IAAI,CAAC,KAAK,CAAC,MAAM,IAAI,CAAC,EACxB,OAAM;AACR,UAAI,CAAC,wBAAE,QAAQ,CAAC,KAAK,CAAC,EACpB,KAAK,GAAG,CAAC,CAAA;AACX,UAAI,KAAK,IAAI,IAAI,CAAC,KAAK,CAAC,MAAM,EAAE,KAAK,GAAG,IAAI,CAAC,KAAK,CAAC,MAAM,GAAG,CAAC,CAAC;;AAE9D,UAAI,IAAI,GAAG,IAAI,CAAA;AACf,UAAI,IAAI,GAAG,IAAI,CAAC,KAAK,CAAC,KAAK,CAAC,CAAA;;AAE5B,UAAI,CAAC,MAAM,GAAG,KAAK,CAAA;AACnB,UAAI,CAAC,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,EAAE,UAAC,GAAG,EAAE,IAAI,EAAK;AAC/C,YAAI,GAAG,EACL,OAAO,OAAK,IAAI,CAAC,OAAO,EAAE,GAAG,CAAC,CAAA;;AAEhC,eAAK,IAAI,CAAC,IAAI,EAAE,UAAC,GAAG,EAAE,IAAI,EAAK;AAC7B,cAAI,CAAC,GAAG,EACN,IAAI,CAAC,IAAI,GAAG,IAAI,CAAA;SACnB,CAAC,CAAA;;AAEF,eAAK,UAAU,GAAG,IAAI,kBAAK,OAAO,EAAE,CAAA;;AAEpC,YAAI,CACD,IAAI,CAAC,OAAK,UAAU,CAAC,CACrB,IAAI,CAAC,QAAQ,EAAE,SAAS,CAAC,CACzB,IAAI,CAAC,QAAQ,EAAE;iBAAM,OAAK,IAAI,EAAE;SAAA,CAAC,CAAA;;AAEpC,iBAAS,SAAS,CAAC,CAAC,EAAE;AACpB,cAAI,CAAC,UAAU,GAAG,CAAC,CAAA;AACnB,cAAI,OAAO,GAAG,4BAAY,CAAA;AAC1B,iBAAO,CAAC,IAAI,CAAC,yBAAY,IAAI,CAAC,UAAU,CAAC,CAAC,CAAA;;AAE1C,cAAI,CAAC,OAAO,GAAG;AACb,4BAAgB,EAAE,IAAI;AACtB,qBAAS,EAAE,OAAO,EACnB,CAAA;;AAED,cAAI,CAAC,IAAI,CAAC,SAAS,EAAE,IAAI,CAAC,CAAA;AAC1B,cAAI,CAAC,OAAO,CAAC,IAAI,CAAC,KAAK,CAAC,CAAA;;;;;AAKxB,cAAI,CAAC,IAAI,CAAC,OAAO,CAAC,CACf,IAAI,CAAC,OAAO,EAAE;mBACb,IAAI,CAAC,IAAI,CAAC,SAAS,EAAE,IAAI,CAAC;WAAA,CAAC,CAAA;SAChC;OACF,CAAC,CAAA;;AAEF,aAAO,IAAI,CAAA;KACZ;;;;;;;;WAMS,mBAAC,MAAM,EAAE;AACd,UAAG,CAAC,IAAI,CAAC,OAAO,EACZ,OAAO;;AAEX,UAAI,CAAC,OAAO,CAAC,OAAO,CAAC,SAAS,CAAC,MAAM,CAAC,CAAC;KAC1C;;;;;;;;;WAOE,cAAC,GAAG,EAAE,QAAQ,EAAE;AAClB,UAAI,OAAO,GAAG,EAAE,GAAG,CAAC,OAAO,CAAC,MAAM,CAAC,IAAI,CAAC,IAAI,GAAG,CAAC,OAAO,CAAC,OAAO,CAAC,IAAI,CAAC,CAAA,AAAC,CAAA;;;AAGtE,UAAI,OAAO,EACT,OAAO,QAAQ,CAAC,IAAI,EAAE,gBAAG,gBAAgB,CAAC,GAAG,CAAC,CAAC,CAAA;;AAEjD,UAAI,IAAI,GAAG,kBAAK,IAAI,CAClB,IAAI,CAAC,OAAO,CAAC,SAAS,EACtB,OA/IG,SAAS,CA+IF,GAAG,CAAC,CACf,CAAA;;AAED,UAAI,gBAAG,UAAU,CAAC,IAAI,CAAC,EACrB,OAAO,QAAQ,CAAC,IAAI,EAAE,gBAAG,gBAAgB,CAAC,IAAI,CAAC,CAAC,CAAA;;AAElD,UAAI,CAAC,QAAQ,CAAC,GAAG,EAAE,QAAQ,CAAC,CAAA;KAC7B;;;;;;;;WAMI,iBAAG;AACN,UAAI,IAAI,CAAC,MAAM,EAAE;AACf,YAAI,CAAC,OAAO,CAAC,OAAO,GAAG,4BAAY,CAAA;AACnC,YAAI,CAAC,OAAO,CAAC,OAAO,CAAC,IAAI,CAAC,yBAAY,IAAI,CAAC,UAAU,CAAC,CAAC,CAAA;;AAEvD,YAAI,CAAC,UAAU,CAAC,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,OAAO,CAAC,CAAA;OAC3C,MAAM;AACL,YAAI,CAAC,OAAO,CAAC,OAAO,CAAC,GAAG,EAAE,CAAA;OAC3B;;AAED,UAAI,CAAC,MAAM,GAAG,CAAC,IAAI,CAAC,MAAM,CAAA;AAC1B,aAAO,IAAI,CAAA;KACZ;;;;;;;;;WAOG,gBAAG;AACL,UAAI,CAAC,IAAI,CAAC,OAAO,EACf,OAAM;;AAER,UAAI,CAAC,OAAO,CACT,cAAc,CACd,MAAM,EAAE,CAAA;;AAEX,UAAI,CAAC,OAAO,CACT,OAAO,CACP,GAAG,EAAE,CAAA;;AAER,aAAM;KACP;;;;;;;;;WAOG,gBAAG;AACL,UAAI,IAAI,GAAG,IAAI,CAAC,KAAK,CAAA;AACrB,UAAI,OAAO,GAAG,IAAI,CAAC,OAAO,CAAA;AAC1B,UAAI,SAAS,GAAG,IAAI,CAAC,OAAO,CAAC,OAAO,GAClC,OAvM8C,YAAY,CAuM7C,wBAAE,UAAU,CAAC,IAAI,EAAE,CAAC,OAAO,CAAC,GAAG,CAAC,CAAC,CAAC,GAC/C,OAAO,CAAC,GAAG,GAAG,CAAC,CAAA;;AAEjB,UAAI,SAAS,IAAI,IAAI,CAAC,MAAM,EAAE;AAC5B,YAAI,CAAC,IAAI,CAAC,OAAO,EAAE,wBAAwB,CAAC,CAAA;AAC5C,YAAI,CAAC,IAAI,CAAC,QAAQ,EAAE,OAAO,CAAC,CAAA;AAC5B,eAAO,IAAI,CAAA;OACZ;;AAED,UAAI,CAAC,IAAI,EAAE,CAAA;AACX,UAAI,CAAC,IAAI,CAAC,SAAS,CAAC,CAAA;;AAEpB,aAAO,IAAI,CAAA;KACZ;;;;;;;;;WAOE,aAAC,IAAI,EAAE;AACR,UAAI,MAAM,GAAG,wBAAE,QAAQ,CAAC,IAAI,CAAC,GAAG,IAAI,GAAG,EAAE,CAAA;;AAEzC,YAAM,CAAC,GAAG,GAAG,IAAI,CAAC,KAAK,CAAC,MAAM,CAAA;;AAE9B,UAAI,wBAAE,QAAQ,CAAC,IAAI,CAAC,EAAE;AACpB,cAAM,CAAC,KAAK,GAAG,OAjOD,SAAS,CAiOE,IAAI,CAAC,CAAA;AAC9B,cAAM,CAAC,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,GAAG,IAAI,CAAA;OAChC;;AAED,UAAI,CAAC,KAAK,CAAC,IAAI,CAAC,MAAM,CAAC,CAAA;KACxB;;;;;;;;;WAOO,kBAAC,GAAG,EAAE,QAAQ,EAAE;AACtB,UAAI,IAAI,GAAG,IAAI,CAAA;AACf,UAAI,MAAM,GAAG,KAAK,CAAA;AAClB,UAAI,QAAQ,GAAG,0CAA0C,CAAA;AACzD,UAAI,UAAU,GAAG,IAAI,CAAC,OAAO,CAAC,UAAU,CAAA;AACxC,UAAI,OAAO,GAAG,GAAG,CAAC,OAAO,CAAC,OAAO,CAAC,KAAK,CAAC,oBA1P7B,KAAK,oBAAX,IAAI,AA0P8C,CAAA;AACvD,UAAI,KAAK,GAAG,GAAG,CAAA;;AAEf,UAAI,UAAU,IAAI,QAAQ,CAAC,IAAI,CAAC,UAAU,CAAC,EAAE;AAC3C,YAAI,UAAU,GAAG,UAAU,CAAC,KAAK,CAAC,QAAQ,CAAC,CAAA;AAC3C,aAAK,GAAG,EAAE,CAAA;AACV,aAAK,CAAC,IAAI,GAAG,GAAG,CAAA;AAChB,aAAK,CAAC,IAAI,GAAG,UAAU,CAAC,CAAC,CAAC,CAAA;AAC1B,aAAK,CAAC,IAAI,GAAG,UAAU,CAAC,CAAC,CAAC,CAAA;OAC3B;;AAED,aAAO,CACJ,GAAG,CAAC,KAAK,EAAE,eAAe,CAAC,CAC3B,IAAI,CAAC,OAAO,EAAE,YAAY,CAAC,CAAA;;AAE9B,eAAS,eAAe,CAAC,GAAG,EAAE;AAC5B,cAAM,GAAG,IAAI,CAAA;;AAEb,YAAI,IAAI,GAAI,GAAG,CAAC,UAAU,KAAK,GAAG,AAAC,CAAA;AACnC,YAAI,OAAO,GAAI,GAAG,CAAC,OAAO,CAAC,cAAc,CAAC,CAAC,OAAO,CAAC,YAAY,CAAC,GAAG,CAAC,CAAC,AAAC,CAAA;AACtE,YAAI,MAAM,GAAG,IAAI,CAAC,OAAO,CAAC,KAAK,CAAA;AAC/B,YAAI,QAAQ,GAAG,IAAI,CAAC,OAAO,CAAC,MAAM,CAAA;;AAElC,YAAI,CAAC,IAAI,EACP,OAAO,QAAQ,CAAC,IAAI,KAAK,CAAC,kBAAkB,CAAC,CAAC,CAAA;AAChD,YAAI,QAAQ,EACV,OAAO,QAAQ,CAAC,IAAI,EAAE,GAAG,CAAC,CAAA;AAC5B,YAAI,CAAC,OAAO,EACV,OAAO,QAAQ,CAAC,IAAI,KAAK,CAAC,8BAA8B,CAAC,CAAC,CAAA;;;AAG5D,YAAI,IAAI,GAAG,8BAAgB,CAAA;;AAE3B,WAAG,CAAC,IAAI,CAAC,IAAI,CAAC,CAAA;;;AAGd,YAAI,CAAC,MAAM,EACT,OAAO,QAAQ,CAAC,IAAI,EAAE,IAAI,CAAC,CAAA;;;AAG7B,YAAI,IAAI,GAAG,kBAAK,IAAI,CAClB,IAAI,CAAC,OAAO,CAAC,SAAS,EACtB,OA5RC,SAAS,CA4RA,GAAG,CAAC,CACf,CAAA;;AAED,YAAI,CAAC,IAAI,CAAC,aAAa,EAAE,GAAG,CAAC,CAAA;AAC7B,YAAI,CAAC,IAAI,CAAC,gBAAG,iBAAiB,CAAC,IAAI,CAAC,CAAC,CAAA;;;AAGrC,gBAAQ,CAAC,IAAI,EAAE,IAAI,CAAC,CAAA;OACrB;;AAED,eAAS,YAAY,CAAC,GAAG,EAAE;AACzB,YAAI,CAAC,MAAM,EACT,QAAQ,CAAC,GAAG,CAAC,CAAA;OAChB;KACF;;;;;WAGG,cAAC,MAAM,EAAE,QAAQ,EAAE;;;AACrB,UAAI;AACF,YAAI,EAAE,GAAG,OAAO,CAAC,eAAe,CAAC,CAAA;OAClC,CAAC,OAAO,GAAG,EAAE;AACZ,eAAO,QAAQ,CAAC,GAAG,CAAC,CAAA;OACrB;;AAED,UAAI,OAAO,GAAG;AACZ,kBAAU,EAAE,IAAI;OACjB,CAAA;;AAED,YAAM,CAAC,EAAE,CAAC,OAAO,EAAE,UAAA,GAAG;eACpB,OAAK,IAAI,CAAC,OAAO,WAAS,GAAG,CAAC,IAAI,UAAK,GAAG,CAAC,IAAI,CAAG;OAAA,CAAC,CAAA;;AAErD,aAAO,EAAE,CAAC,MAAM,EAAE,OAAO,EAAE,QAAQ,CAAC,CAAA;KACrC;;;;;;WAIO,kBAAC,QAAQ,EAAE;AACjB,UAAI,KAAK,GAAG,EAAE,CAAA;AACd,UAAI,IAAI,GAAG,QAAQ,CAAC,KAAK,CAAA;AACzB,UAAI,QAAQ,GAAG,QAAQ,CAAC,QAAQ,CAAC,QAAQ,CAAC,CAAA;AAC1C,UAAI,IAAI,GAAG,KAAK,GAAG,CAAC,CAAA;AACpB,UAAI,KAAK,GAAG,AAAC,QAAQ,GAAG,IAAI,GAAI,KAAK,CAAA;AACrC,UAAI,MAAM,GAAG,OAAO,CAAC,MAAM,CAAA;;AAE3B,aAAO,CAAC,OAAO,CAAC,CAAC,QAAQ,CACvB,UAAC,QAAQ,EAAK;;AAEZ,cAAM,CAAC,KAAK,CAAC,sBAAsB,CAAC,CAAA;;;AAGpC,cAAM,CAAC,QAAQ,CAAC,CAAC,CAAC,CAAA;AAClB,cAAM,CAAC,KAAK,CAAC,OA/UkB,WAAW,CA+UjB,KAAK,GAAG,IAAI,EAAE,KAAK,EAAE,IAAI,CAAC,CAAC,CAAA;;AAEpD,kBAAU,CAAC,QAAQ,EAAE,KAAK,CAAC,CAAA;;AAE3B,YAAI,EAAE,CAAA;OACP,EACD;eAAM,IAAI,GAAG,CAAC;OAAA,EACd,UAAC,IAAI,EAAK;AACR,cAAM,CAAC,UAAU,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,CAAA;AACxB,cAAM,CAAC,SAAS,EAAE,CAAA;AAClB,cAAM,CAAC,QAAQ,CAAC,CAAC,CAAC,CAAA;OACnB,CACF,CAAA;KACF;;;SA5UkB,MAAM;WAjBlB,YAAY;;qBAiBA,MAAM","file":"libs/player.js","sourcesContent":["/**\n*\n* Command line interface mp3 player based on Node.js\n* @Author:   [turingou](http://guoyu.me)\n* @Created:  [2013/07/20]\n*\n**/\n\nimport fs from 'fs'\nimport path from 'path'\nimport util from \"util\"\nimport { http, https } from 'follow-redirects'\nimport home from 'home'\nimport lame from 'lame'\nimport _ from 'underscore'\nimport Speaker from 'speaker'\nimport PoolStream from 'pool_stream'\nimport Volume from 'pcm-volume'\nimport { EventEmitter } from \"events\"\nimport { fetchName, splitName, format, getProgress, chooseRandom } from './utils'\n\nconst defaults = {\n  'src': 'src',\n  'cache': false,\n  'stream': false,\n  'shuffle': false,\n  'downloads': home(),\n  'http_proxy': process.env.HTTP_PROXY || process.env.http_proxy || null,\n}\n\n/**\n * [Class Player]\n * @param {Array|String} songs  [A list of songs or a single song URI string.]\n * @param {Object}       params [Optional options when init a instance]\n */\nexport default class Player extends EventEmitter {\n  constructor(songs, params) {\n//    if (!songs)\n//      return\n\n    // Inherits eventEmitter\n    super()\n\n    this.history = []\n    this.paused = false\n    this.options = _.extend(defaults, params)\n    this._list = format(songs || [], this.options.src)\n    if (!this._list || !this._list.length) this._list = []\n  }\n\n  // Enable or disable a option\n  enable(k) {\n    this.options[k] = true\n    return this\n  }\n\n  disable(k) {\n    this.options[k] = false\n    return this\n  }\n\n  /**\n   * [Lists songs in the playlist,\n   * Displays the src for each song returned in array,\n   * Access with prop `player.list`]\n   */\n  get list() {\n    if (!this._list)\n      return\n\n    return this._list.map(el => el[this.options.src])\n  }\n\n  // Get the lastest playing song\n  get playing() {\n    if (!this.history.length)\n      return null\n\n    return this._list[this.history[this.history.length - 1]]\n  }\n\n  /**\n   * [Play a MP3 encoded audio file]\n   * @param  {Number} index [the selected index of first played song]\n   */\n  play(index = 0) {\n    if (this._list.length <= 0)\n      return\n    if (!_.isNumber(index))\n      index = 0\n    if (index >= this._list.length) index = this._list.length - 1;\n\n    let self = this\n    let song = this._list[index]\n\n    this.paused = false\n    this.read(song[this.options.src], (err, pool) => {\n      if (err)\n        return this.emit('error', err)\n\n      this.meta(pool, (err, data) => {\n        if (!err) \n          song.meta = data\n      })\n\n      this.lameStream = new lame.Decoder()\n\n      pool\n        .pipe(this.lameStream)\n        .once('format', onPlaying)\n        .once('finish', () => this.next())\n\n      function onPlaying(f) {\n        self.lameFormat = f\n        var speaker = new Volume()\n        speaker.pipe(new Speaker(self.lameFormat))\n\n        self.speaker = {\n          'readableStream': this,\n          'Speaker': speaker,\n        }\n\n        self.emit('playing', song)\n        self.history.push(index)\n\n        // This is where the song acturaly played end,\n        // can't trigger playend event here cause\n        // unpipe will fire this speaker's close event.\n        this.pipe(speaker)\n          .once('close', () => \n            self.emit('playend', song))\n      }\n    })\n\n    return this\n  }\n\n  /**\n   * [Set playback volume]\n   * @param  {Number}   volume   [Volume level percentage 0.0-1.0]\n   */\n   setVolume(volume) {\n       if(!this.speaker)\n           return;\n\n       this.speaker.Speaker.setVolume(volume);\n   }\n\n  /**\n   * [Read MP3 src and check if we're going to download it.]\n   * @param  {String}   src      [MP3 file src, would be local path or URI (http/https)]\n   * @param  {Function} callback [callback with err and file stream]\n   */\n  read(src, callback) {\n    var isLocal = !(src.indexOf('http') == 0 || src.indexOf('https') == 0)\n\n    // Read local file stream if not a valid URI\n    if (isLocal)\n      return callback(null, fs.createReadStream(src))\n\n    var file = path.join(\n      this.options.downloads,\n      fetchName(src)\n    )\n\n    if (fs.existsSync(file))\n      return callback(null, fs.createReadStream(file))\n\n    this.download(src, callback)\n  }\n\n  /**\n   * [Pause or resume audio]\n   * @return {player} this\n   */\n  pause() {\n    if (this.paused) {\n      this.speaker.Speaker = new Volume()\n      this.speaker.Speaker.pipe(new Speaker(this.lameFormat))\n\n      this.lameStream.pipe(this.speaker.Speaker)\n    } else {\n      this.speaker.Speaker.end()\n    }\n\n    this.paused = !this.paused\n    return this\t\n  }\n\n  /**\n   * [Stop playing and unpipe stream.\n   * No params for now.]\n   * @return {Bool} [always `false`]\n   */\n  stop() {\n    if (!this.speaker)\n      return\n\n    this.speaker\n      .readableStream\n      .unpipe()\n\n    this.speaker\n      .Speaker\n      .end()\n\n    return\n  }\n\n  /**\n   * [Stop playing and switch to next song,\n   * if there is no next song, trigger a `No next song` error event]\n   * @return {player} this\n   */\n  next() {\n    let list = this._list\n    let current = this.playing\n    let nextIndex = this.options.shuffle ? \n      chooseRandom(_.difference(list, [current._id])) :\n      current._id + 1\n\n    if (nextIndex >= list.length) {\n      this.emit('error', 'No next song was found')\n      this.emit('finish', current)\n      return this\n    }\n\n    this.stop()\n    this.play(nextIndex)\n\n    return this\n  }\n\n  /**\n   * [Add a new song to the playlist,\n   * If provided `song` is a String, it will be converted to a `Song` Object.]\n   * @param {String|Object} song [src URI of new song or the object of new song.]\n   */\n  add(song) {\n    var latest = _.isObject(song) ? song : {}\n\n    latest._id = this._list.length\n\n    if (_.isString(song)) {\n      latest._name = splitName(song)\n      latest[this.options.src] = song\n    }\n\n    this._list.push(latest)\n  }\n\n  /**\n   * [Download a mp3 file from its URI]\n   * @param  {String}   src      [the src URI of mp3 file]\n   * @param  {Function} callback [callback with err and file stream]\n   */\n  download(src, callback) {\n    var self = this\n    var called = false\n    var proxyReg = /http:\\/\\/((?:\\d{1,3}\\.){3}\\d{1,3}):(\\d+)/\n    var http_proxy = self.options.http_proxy\n    var request = src.indexOf('https') === 0 ? https : http\n    var query = src\n\n    if (http_proxy && proxyReg.test(http_proxy)) {\n      var proxyGroup = http_proxy.match(proxyReg)\n      query = {}\n      query.path = src\n      query.host = proxyGroup[1]\n      query.port = proxyGroup[2]\n    }\n\n    request\n      .get(query, responseHandler)\n      .once('error', errorHandler)\n\n    function responseHandler(res) {\n      called = true\n\n      var isOk = (res.statusCode === 200)\n      var isAudio = (res.headers['content-type'].indexOf('audio/mpeg') > -1)\n      var isSave = self.options.cache\n      var isStream = self.options.stream\n\n      if (!isOk)\n        return callback(new Error('Resource invalid'))\n      if (isStream)\n        return callback(null, res)\n      if (!isAudio)\n        return callback(new Error('Resource type is unsupported'))\n\n      // Create a pool\n      var pool = new PoolStream()\n      // Pipe into memory\n      res.pipe(pool)\n\n      // Check if we're going to save this stream\n      if (!isSave)\n        return callback(null, pool)\n\n      // Save this stream as file in download directory\n      var file = path.join(\n        self.options.downloads,\n        fetchName(src)\n      )\n\n      self.emit('downloading', src)\n      pool.pipe(fs.createWriteStream(file))\n\n      // Callback the pool\n      callback(null, pool)\n    }\n\n    function errorHandler(err) {\n      if (!called)\n        callback(err)\n    }\n  }\n\n  // Fetch metadata from local or remote mp3 stream\n  meta(stream, callback) {\n    try {\n      var mm = require('musicmetadata')\n    } catch (err) {\n      return callback(err)\n    }\n\n    var options = {\n      'duration': true\n    }\n\n    stream.on('error', err => \n      this.emit('error', `出错了 ${err.code}: ${err.path}`))\n\n    return mm(stream, options, callback)\n  }\n\n  // Format metadata with template \n  // And output to `stdout`\n  progress(metadata) {\n    var total = 70\n    var info = metadata.title\n    var duration = parseInt(metadata.duration)\n    var dots = total - 1\n    var speed = (duration * 1000) / total\n    var stdout = process.stdout\n\n    require('async').doWhilst(\n      (callback) => {\n        // Clear console\n        stdout.write('\\u001B[2J\\u001B[0;0f')\n\n        // Move cursor to beginning of line\n        stdout.cursorTo(0)\n        stdout.write(getProgress(total - dots, total, info))\n\n        setTimeout(callback, speed)\n\n        dots--\n      },\n      () => dots > 0,\n      (done) => {\n        stdout.moveCursor(0, -1)\n        stdout.clearLine()\n        stdout.cursorTo(0)\n      }\n    )\n  }\n}\n"]}